<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Claim Assessment - AI-Powered Insurance Assistant</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #06b6d4;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --bg-light: #f8fafc;
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            min-height: 100vh;
        }

        /* Header Component */
        .header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255,255,255,0.2);
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.1rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Navigation */
        .navigation {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .nav-btn {
            background: rgba(255,255,255,0.95);
            color: var(--primary-color);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 16px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: var(--shadow-md);
        }

        .nav-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .nav-btn.active {
            background: var(--primary-color);
            color: white;
        }

        /* Main Content Area */
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        /* Phase Indicator */
        .phase-indicator {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-md);
            backdrop-filter: blur(10px);
            text-align: center;
        }

        .phase-indicator h3 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }

        .phase-indicator p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Assessment Form (Phase 1) */
        .assessment-container {
            background: white;
            border-radius: 24px;
            padding: 3rem;
            box-shadow: var(--shadow-xl);
            position: relative;
            overflow: hidden;
        }

        .assessment-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }

        .form-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .form-header h2 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .form-header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* Progress Indicator */
        .progress-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 3rem;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 120px;
            justify-content: center;
        }

        .progress-step.active {
            background: var(--primary-color);
            color: white;
            transform: scale(1.05);
        }

        .progress-step.completed {
            background: var(--success-color);
            color: white;
        }

        .progress-step.pending {
            background: var(--bg-light);
            color: var(--text-secondary);
        }

        /* Form Grid */
        .form-grid {
            display: grid;
            gap: 2.5rem;
        }

        .form-section {
            background: var(--bg-light);
            border-radius: 20px;
            padding: 2.5rem;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .form-section:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .section-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1rem;
        }

        /* Form Controls */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }

        .form-label.required::after {
            content: ' *';
            color: var(--danger-color);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Radio Groups */
        .radio-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin-top: 0.75rem;
        }

        .radio-option {
            position: relative;
        }

        .radio-input {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .radio-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-align: center;
            min-height: 60px;
        }

        .radio-input:checked + .radio-label {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .radio-label:hover {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.05);
        }

        .radio-input:checked + .radio-label:hover {
            background: var(--secondary-color);
        }

        /* Textarea */
        .textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        /* Submit Button */
        .submit-section {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
            text-align: center;
        }

        .submit-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 1.25rem 3rem;
            border-radius: 16px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-lg);
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-xl);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Conversational AI Section (Phase 2) */
        .conversational-container {
            background: white;
            border-radius: 24px;
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            display: none;
        }

        .chat-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 2rem;
            text-align: center;
            position: relative;
        }

        .chat-header h2 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
        }

        .chat-header .subtitle {
            opacity: 0.9;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .stage-indicator {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.8rem;
            backdrop-filter: blur(5px);
        }

        .chat-messages {
            height: 500px;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 20px;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            text-align: right;
        }

        .message.assistant {
            text-align: left;
        }

        .message-content {
            display: inline-block;
            max-width: 80%;
            padding: 15px 20px;
            border-radius: 20px;
            position: relative;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.assistant .message-content {
            background: white;
            border: 1px solid #e9ecef;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.6;
            margin-top: 5px;
        }

        .chat-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
        }

        .input-group {
            position: relative;
        }

        .form-control {
            border-radius: 25px;
            border: 2px solid #e9ecef;
            padding: 15px 20px;
            font-size: 1rem;
            transition: all 0.3s ease;
            width: 100%;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            outline: none;
        }

        .btn-send {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            color: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .btn-send:hover {
            transform: translateY(-50%) scale(1.1);
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        .suggestions {
            margin-top: 15px;
        }

        .suggestion-btn {
            display: inline-block;
            margin: 5px;
            padding: 8px 15px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: #495057;
        }

        .suggestion-btn:hover {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .typing-indicator {
            display: none;
            padding: 15px 20px;
            background: white;
            border-radius: 20px;
            border-bottom-left-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 80%;
        }

        .typing-dots {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary-color);
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .session-status {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 10px 15px;
            margin-bottom: 20px;
            border-radius: 0 10px 10px 0;
            font-size: 0.9rem;
        }

        .plan-info {
            background: #f3e5f5;
            border-left: 4px solid #9c27b0;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 0 10px 10px 0;
            font-size: 0.9rem;
        }

        .eligibility-result {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid;
        }

        .eligibility-result.eligible {
            background: #e8f5e8;
            border-color: #28a745;
            color: #155724;
        }

        .eligibility-result.not-eligible {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .clarification-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        /* Loading States */
        .loading {
            display: none;
            text-align: center;
            padding: 4rem;
            background: white;
            border-radius: 24px;
            box-shadow: var(--shadow-xl);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--bg-light);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            flex-wrap: wrap;
            padding: 2rem;
            background: white;
            border-top: 1px solid var(--border-color);
        }

        .btn {
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Error Messages */
        .error-message {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            color: var(--danger-color);
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid #fecaca;
            margin-bottom: 2rem;
            display: none;
            font-weight: 500;
        }

        /* Success Messages */
        .success-message {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            color: var(--success-color);
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid #bbf7d0;
            margin-bottom: 2rem;
            display: none;
            font-weight: 500;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 0.5rem;
            }

            .assessment-container, .conversational-container {
                padding: 2rem 1.5rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .radio-group {
                grid-template-columns: 1fr;
            }

            .navigation {
                flex-direction: column;
                gap: 0.5rem;
            }

            .action-buttons {
                flex-direction: column;
            }

            .header h1 {
                font-size: 2rem;
            }

            .progress-indicator {
                flex-direction: column;
                gap: 0.5rem;
            }

            .progress-step {
                min-width: auto;
                width: 100%;
            }

            .chat-messages {
                height: 400px;
            }
            
            .message-content {
                max-width: 90%;
            }
        }

        /* Enhanced Animations */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        .slide-up {
            animation: slideUp 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header slide-up">
            <h1>üè• Enhanced Claim Assessment</h1>
            <p>AI-Powered Insurance Claim Analysis with Conversational Intelligence</p>
        </div>

        <!-- Navigation -->
        <div class="navigation slide-up">
            <a href="/" class="nav-btn">üè† Home</a>
            <a href="/chat" class="nav-btn">üí¨ Chat</a>
            <a href="/plans" class="nav-btn">üìã Plans</a>
            <a href="/claims" class="nav-btn active">üîç Enhanced Claims</a>
        </div>

        <!-- Phase Indicator -->
        <div class="phase-indicator fade-in" id="phaseIndicator">
            <h3 id="phaseTitle">üìã Phase 1: Initial Assessment</h3>
            <p id="phaseDescription">Complete the claim assessment form to begin intelligent analysis</p>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Phase 1: Assessment Form (Keep original questions unchanged) -->
            <div class="assessment-container fade-in" id="assessmentForm">
                <div class="form-header">
                    <h2>Smart Claim Assessment</h2>
                    <p>Complete your claim details - our AI will then guide you through intelligent clarifications</p>
                </div>

                <!-- Progress Indicator -->
                <div class="progress-indicator">
                    <div class="progress-step active" id="step1">
                        <span>üìã</span>
                        <span>Basic Details</span>
                    </div>
                    <div class="progress-step pending" id="step2">
                        <span>üõ£Ô∏è</span>
                        <span>Claim Type</span>
                    </div>
                    <div class="progress-step pending" id="step3">
                        <span>üìù</span>
                        <span>Details</span>
                    </div>
                    <div class="progress-step pending" id="step4">
                        <span>ü§ñ</span>
                        <span>AI Analysis</span>
                    </div>
                </div>

                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>

                <form id="claimForm">
                    <div class="form-grid">
                        <!-- Basic Details Section -->
                        <div class="form-section">
                            <div class="section-title">
                                <div class="section-icon">üìã</div>
                                Basic Details
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Patient Name (As per Aadhaar)</label>
                                    <input type="text" class="form-input" id="patientName" name="patient_name" placeholder="Enter full name as per Aadhaar">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Insurance Company</label>
                                    <select class="form-select" id="companySelect" name="company_name">
                                        <option value="">Select Insurance Company</option>
                                        <!-- Companies will be loaded dynamically -->
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Plan Name</label>
                                    <select class="form-select" id="planSelect" name="plan_name" disabled>
                                        <option value="">First select insurance company</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Plan Variant (Sum Insured)</label>
                                    <select class="form-select" id="variantSelect" name="sum_insured" disabled>
                                        <option value="">First select plan</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Additional Context</label>
                                <textarea class="form-input textarea" id="basicDescription" name="basic_description" placeholder="Provide any additional context about your policy, patient details, or circumstances..."></textarea>
                            </div>
                        </div>

                        <!-- Claim Type Selector -->
                        <div class="form-section">
                            <div class="section-title">
                                <div class="section-icon">üõ£Ô∏è</div>
                                What is the cause of the claim?
                            </div>
                            
                            <div class="form-group">
                                <div class="radio-group">
                                    <div class="radio-option">
                                        <input type="radio" id="claimTypeAccident" name="claim_type" value="Accident" class="radio-input">
                                        <label for="claimTypeAccident" class="radio-label">üöó Accident</label>
                                    </div>
                                    <div class="radio-option">
                                        <input type="radio" id="claimTypeIllness" name="claim_type" value="Illness" class="radio-input">
                                        <label for="claimTypeIllness" class="radio-label">üß¨ Illness</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Accident Flow Section -->
                        <div class="form-section" id="accidentFlowSection" style="display: none;">
                            <div class="section-title">
                                <div class="section-icon">üöó</div>
                                Accident Details
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Type of Accident</label>
                                <div class="radio-group">
                                    <div class="radio-option">
                                        <input type="radio" id="accidentRTA" name="accident_type" value="RTA" class="radio-input">
                                        <label for="accidentRTA" class="radio-label">üöó RTA (Road Traffic Accident)</label>
                                    </div>
                                    <div class="radio-option">
                                        <input type="radio" id="accidentDomestic" name="accident_type" value="Domestic" class="radio-input">
                                        <label for="accidentDomestic" class="radio-label">üè† Domestic</label>
                                    </div>
                                </div>
                            </div>

                            <!-- RTA Specific Questions -->
                            <div id="rtaQuestions" style="display: none;">
                                <div class="form-group">
                                    <label class="form-label">Do you have any proof? (FIR, police report, accident note, etc.)</label>
                                    <div class="radio-group">
                                        <div class="radio-option">
                                            <input type="radio" id="rtaProofYes" name="rta_proof" value="Yes" class="radio-input">
                                            <label for="rtaProofYes" class="radio-label">‚úÖ Yes</label>
                                        </div>
                                        <div class="radio-option">
                                            <input type="radio" id="rtaProofNo" name="rta_proof" value="No" class="radio-input">
                                            <label for="rtaProofNo" class="radio-label">‚ùå No</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Expected Claim Amount (‚Çπ)</label>
                                    <input type="number" class="form-input" id="rtaClaimAmount" name="claim_amount" min="1" placeholder="Total treatment cost in rupees">
                                </div>
                            </div>

                            <!-- Domestic Accident Questions -->
                            <div id="domesticQuestions" style="display: none;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">When did the accident occur?</label>
                                        <input type="date" class="form-input" id="accidentDate" name="accident_date">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Expected Claim Amount (‚Çπ)</label>
                                        <input type="number" class="form-input" id="domesticClaimAmount" name="claim_amount" min="1" placeholder="Total treatment cost in rupees">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Describe the accident</label>
                                    <textarea class="form-input textarea" id="accidentDescription" name="accident_description" placeholder="Please describe how the accident occurred, injuries sustained, etc."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Illness Flow Section -->
                        <div class="form-section" id="illnessFlowSection" style="display: none;">
                            <div class="section-title">
                                <div class="section-icon">üß¨</div>
                                Illness Details
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">What is the illness/condition?</label>
                                <input type="text" class="form-input" id="conditionName" name="condition_name" placeholder="Enter the medical condition or illness">
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">When was the illness first diagnosed?</label>
                                    <input type="date" class="form-input" id="diagnosisDate" name="diagnosis_date">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Expected Claim Amount (‚Çπ)</label>
                                    <input type="number" class="form-input" id="illnessClaimAmount" name="claim_amount" min="1" placeholder="Total treatment cost in rupees">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Is this related to a pre-existing condition?</label>
                                <div class="radio-group">
                                    <div class="radio-option">
                                        <input type="radio" id="preExistingYes" name="pre_existing" value="Yes" class="radio-input">
                                        <label for="preExistingYes" class="radio-label">‚úÖ Yes</label>
                                    </div>
                                    <div class="radio-option">
                                        <input type="radio" id="preExistingNo" name="pre_existing" value="No" class="radio-input">
                                        <label for="preExistingNo" class="radio-label">‚ùå No</label>
                                    </div>
                                    <div class="radio-option">
                                        <input type="radio" id="preExistingUnsure" name="pre_existing" value="Unsure" class="radio-input">
                                        <label for="preExistingUnsure" class="radio-label">‚ùì Unsure</label>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Describe the illness and treatment</label>
                                <textarea class="form-input textarea" id="illnessDescription" name="illness_description" placeholder="Please describe the illness, symptoms, treatment received, etc."></textarea>
                            </div>
                        </div>

                        <!-- Additional Information Section -->
                        <div class="form-section">
                            <div class="section-title">
                                <div class="section-icon">üìù</div>
                                Additional Information
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Do you have all the required documents?</label>
                                <div class="radio-group">
                                    <div class="radio-option">
                                        <input type="radio" id="documentsYes" name="documents_ready" value="Yes" class="radio-input">
                                        <label for="documentsYes" class="radio-label">‚úÖ Yes, all ready</label>
                                    </div>
                                    <div class="radio-option">
                                        <input type="radio" id="documentsPartial" name="documents_ready" value="Partial" class="radio-input">
                                        <label for="documentsPartial" class="radio-label">üìÑ Some ready</label>
                                    </div>
                                    <div class="radio-option">
                                        <input type="radio" id="documentsNo" name="documents_ready" value="No" class="radio-input">
                                        <label for="documentsNo" class="radio-label">‚ùå Need help</label>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Any additional details or questions?</label>
                                <textarea class="form-input textarea" id="additionalInfo" name="additional_info" placeholder="Share any other relevant information, concerns, or questions you have about your claim..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Section -->
                    <div class="submit-section">
                        <button type="submit" class="submit-btn" id="submitBtn">
                            <i class="fas fa-robot"></i>
                            Start AI Analysis
                        </button>
                        <p style="margin-top: 1rem; color: var(--text-secondary); font-size: 0.9rem;">
                            Our AI will analyze your submission and guide you through intelligent clarifications
                        </p>
                    </div>
                </form>
            </div>

            <!-- Loading Screen -->
            <div class="loading" id="loadingScreen">
                <div class="loading-spinner"></div>
                <h3>ü§ñ AI is Analyzing Your Claim</h3>
                <p>Processing your information with plan-specific intelligence...</p>
            </div>

            <!-- Phase 2: Conversational AI Interface -->
            <div class="conversational-container" id="conversationalInterface">
                <div class="chat-header">
                    <div class="stage-indicator">AI Analysis Phase</div>
                    <h2>ü§ñ Smart Claim Assistant</h2>
                    <div class="subtitle">Conversational Intelligence for Enhanced Accuracy</div>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <!-- Session status will be shown here -->
                    <div class="session-status" id="sessionStatus" style="display: none;">
                        <strong>Session Status:</strong> <span id="sessionStatusText">Active</span>
                    </div>
                    
                    <!-- Plan information will be shown here -->
                    <div class="plan-info" id="planInfo" style="display: none;">
                        <strong>Active Plan:</strong> <span id="activePlanText"></span>
                    </div>
                </div>

                <div class="chat-input-container">
                    <div class="input-group">
                        <input type="text" class="form-control" id="chatInput" placeholder="Type your response..." disabled>
                        <button class="btn-send" id="sendBtn" disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="suggestions" id="suggestionsContainer"></div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-secondary" id="resetBtn">
                        <i class="fas fa-redo"></i>
                        Start Over
                    </button>
                    <button class="btn btn-primary" id="downloadBtn" style="display: none;">
                        <i class="fas fa-download"></i>
                        Download Analysis
                    </button>
                    <button class="btn btn-success" id="continueBtn" style="display: none;">
                        <i class="fas fa-arrow-right"></i>
                        Continue to Filing
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state management
        let currentPhase = 1;
        let sessionId = null;
        let conversationHistory = [];
        let planData = null;
        let claimData = null;
        let companies = [];
        let allPlans = {};

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            await loadCompanies();
            setupEventListeners();
            console.log('Enhanced Claim Assessment initialized');
        });

        // Load companies and plans
        async function loadCompanies() {
            try {
                const response = await fetch('/api/companies');
                if (response.ok) {
                    companies = await response.json();
                    populateCompanySelect();
                } else {
                    // Fallback - load from file system if API not available
                    await loadCompaniesFromFileSystem();
                }
            } catch (error) {
                console.warn('API not available, loading from file system');
                await loadCompaniesFromFileSystem();
            }
        }

        async function loadCompaniesFromFileSystem() {
            try {
                // Load plan data from multiple books
                const bookPaths = [
                    'data/plans/book1/plan_name_suminsuredrange.json',
                    'data/plans/book2/plan_name_suminsuredrange.json',
                    'data/plans/book4/plan_name_suminsuredrange.json',
                    'data/plans/book6/plan_name_suminsuredrange.json',
                    'data/plans/book8/plan_name_suminsuredrange.json',
                    'data/plans/book9/plan_name_suminsuredrange.json',
                    'data/plans/book11/plan_name_suminsuredrange.json',
                    'data/plans/book12/plan_name_suminsuredrange.json',
                    'data/plans/book13/plan_name_suminsuredrange.json',
                    'data/plans/book14/plan_name_suminsuredrange.json'
                ];

                const companySet = new Set();
                allPlans = {};

                for (const path of bookPaths) {
                    try {
                        const response = await fetch(path);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.company) {
                                companySet.add(data.company);
                                if (!allPlans[data.company]) {
                                    allPlans[data.company] = {};
                                }
                                if (data.plans) {
                                    for (const [planName, variants] of Object.entries(data.plans)) {
                                        allPlans[data.company][planName] = variants;
                                    }
                                }
                            }
                        }
                    } catch (error) {
                        console.warn(`Failed to load plan data from ${path}:`, error);
                    }
                }

                companies = Array.from(companySet).sort();
                populateCompanySelect();
            } catch (error) {
                console.error('Failed to load company data:', error);
                showError('Failed to load insurance company data');
            }
        }

        function populateCompanySelect() {
            const companySelect = document.getElementById('companySelect');
            companySelect.innerHTML = '<option value="">Select Insurance Company</option>';
            
            companies.forEach(company => {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company;
                companySelect.appendChild(option);
            });
        }

        function setupEventListeners() {
            // Company selection
            document.getElementById('companySelect').addEventListener('change', onCompanyChange);
            
            // Plan selection
            document.getElementById('planSelect').addEventListener('change', onPlanChange);
            
            // Claim type selection
            document.querySelectorAll('input[name="claim_type"]').forEach(radio => {
                radio.addEventListener('change', onClaimTypeChange);
            });

            // Accident type selection
            document.querySelectorAll('input[name="accident_type"]').forEach(radio => {
                radio.addEventListener('change', onAccidentTypeChange);
            });

            // Form submission
            document.getElementById('claimForm').addEventListener('submit', onFormSubmit);

            // Chat functionality
            document.getElementById('chatInput').addEventListener('keypress', onChatInputKeypress);
            document.getElementById('sendBtn').addEventListener('click', sendMessage);

            // Action buttons
            document.getElementById('resetBtn').addEventListener('click', resetAssessment);
            document.getElementById('downloadBtn').addEventListener('click', downloadAnalysis);
            document.getElementById('continueBtn').addEventListener('click', continueToFiling);
        }

        function onCompanyChange(event) {
            const selectedCompany = event.target.value;
            const planSelect = document.getElementById('planSelect');
            const variantSelect = document.getElementById('variantSelect');

            // Clear dependent dropdowns
            planSelect.innerHTML = '<option value="">Select Plan</option>';
            variantSelect.innerHTML = '<option value="">First select plan</option>';
            variantSelect.disabled = true;

            if (selectedCompany && allPlans[selectedCompany]) {
                planSelect.disabled = false;
                Object.keys(allPlans[selectedCompany]).forEach(planName => {
                    const option = document.createElement('option');
                    option.value = planName;
                    option.textContent = planName;
                    planSelect.appendChild(option);
                });
            } else {
                planSelect.disabled = true;
            }
        }

        function onPlanChange(event) {
            const selectedCompany = document.getElementById('companySelect').value;
            const selectedPlan = event.target.value;
            const variantSelect = document.getElementById('variantSelect');

            variantSelect.innerHTML = '<option value="">Select Sum Insured</option>';

            if (selectedCompany && selectedPlan && allPlans[selectedCompany][selectedPlan]) {
                variantSelect.disabled = false;
                allPlans[selectedCompany][selectedPlan].forEach(variant => {
                    const option = document.createElement('option');
                    option.value = variant;
                    option.textContent = variant;
                    variantSelect.appendChild(option);
                });
            } else {
                variantSelect.disabled = true;
            }
        }

        function onClaimTypeChange(event) {
            const claimType = event.target.value;
            const accidentSection = document.getElementById('accidentFlowSection');
            const illnessSection = document.getElementById('illnessFlowSection');

            // Hide all sections first
            accidentSection.style.display = 'none';
            illnessSection.style.display = 'none';

            // Show relevant section
            if (claimType === 'Accident') {
                accidentSection.style.display = 'block';
                updateProgressStep(2);
            } else if (claimType === 'Illness') {
                illnessSection.style.display = 'block';
                updateProgressStep(2);
            }
        }

        function onAccidentTypeChange(event) {
            const accidentType = event.target.value;
            const rtaQuestions = document.getElementById('rtaQuestions');
            const domesticQuestions = document.getElementById('domesticQuestions');

            // Hide all subsections
            rtaQuestions.style.display = 'none';
            domesticQuestions.style.display = 'none';

            // Show relevant subsection
            if (accidentType === 'RTA') {
                rtaQuestions.style.display = 'block';
            } else if (accidentType === 'Domestic') {
                domesticQuestions.style.display = 'block';
            }
            
            updateProgressStep(3);
        }

        function updateProgressStep(step) {
            for (let i = 1; i <= 4; i++) {
                const stepElement = document.getElementById(`step${i}`);
                if (i < step) {
                    stepElement.className = 'progress-step completed';
                } else if (i === step) {
                    stepElement.className = 'progress-step active';
                } else {
                    stepElement.className = 'progress-step pending';
                }
            }
        }

        async function onFormSubmit(event) {
            event.preventDefault();
            
            if (!validateForm()) {
                return;
            }

            // Collect form data
            claimData = collectFormData();
            
            // Show loading
            showLoading();
            updateProgressStep(4);
            
            try {
                // Start conversational analysis
                await startConversationalAnalysis();
            } catch (error) {
                console.error('Analysis failed:', error);
                showError('Failed to start AI analysis. Please try again.');
                hideLoading();
            }
        }

        function validateForm() {
            const requiredFields = [
                'patient_name',
                'company_name',
                'plan_name',
                'sum_insured',
                'claim_type'
            ];

            for (const field of requiredFields) {
                const element = document.querySelector(`[name="${field}"]`);
                if (!element || !element.value.trim()) {
                    showError(`Please fill in the ${field.replace('_', ' ')} field`);
                    return false;
                }
            }

            // Validate claim type specific fields
            const claimType = document.querySelector('input[name="claim_type"]:checked').value;
            
            if (claimType === 'Accident') {
                const accidentType = document.querySelector('input[name="accident_type"]:checked');
                if (!accidentType) {
                    showError('Please select the type of accident');
                    return false;
                }
                
                const claimAmount = accidentType.value === 'RTA' ?
                    document.getElementById('rtaClaimAmount').value :
                    document.getElementById('domesticClaimAmount').value;
                    
                if (!claimAmount) {
                    showError('Please enter the expected claim amount');
                    return false;
                }
            } else if (claimType === 'Illness') {
                const requiredIllnessFields = ['condition_name', 'diagnosis_date', 'claim_amount'];
                for (const field of requiredIllnessFields) {
                    const element = document.getElementById(field === 'claim_amount' ? 'illnessClaimAmount' : field);
                    if (!element || !element.value.trim()) {
                        showError(`Please fill in the ${field.replace('_', ' ')} field`);
                        return false;
                    }
                }
            }

            return true;
        }

        function collectFormData() {
            const formData = new FormData(document.getElementById('claimForm'));
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            return data;
        }

        async function startConversationalAnalysis() {
            try {
                // Initialize session
                sessionId = generateSessionId();
                
                // Load plan data
                await loadPlanData();
                
                // Start conversation
                const response = await fetch('/api/chat/start-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        claimData: claimData,
                        planData: planData
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                // Hide loading and show conversational interface
                hideLoading();
                showConversationalInterface();
                
                // Start conversation
                if (result.initialMessage) {
                    addMessage('assistant', result.initialMessage);
                }
                
                enableChatInput();
                
            } catch (error) {
                console.error('Failed to start conversational analysis:', error);
                // Fallback to client-side analysis
                await fallbackAnalysis();
            }
        }

        async function loadPlanData() {
            const company = claimData.company_name;
            const planName = claimData.plan_name;
            const sumInsured = claimData.sum_insured;
            
            try {
                // Try to load specific plan data
                const planResponse = await fetch(`/api/plan-data?company=${encodeURIComponent(company)}&plan=${encodeURIComponent(planName)}&sumInsured=${encodeURIComponent(sumInsured)}`);
                
                if (planResponse.ok) {
                    planData = await planResponse.json();
                } else {
                    // Fallback - use basic plan info
                    planData = {
                        company: company,
                        planName: planName,
                        sumInsured: sumInsured,
                        features: 'Standard coverage features'
                    };
                }
            } catch (error) {
                console.warn('Failed to load detailed plan data:', error);
                planData = {
                    company: company,
                    planName: planName,
                    sumInsured: sumInsured
                };
            }
        }

        async function fallbackAnalysis() {
            hideLoading();
            showConversationalInterface();
            
            const welcomeMessage = `Hello! I've received your claim details for ${claimData.plan_name} with ${claimData.company_name}.

Based on your ${claimData.claim_type.toLowerCase()} claim, I have a few questions to ensure we process this accurately:

1. Can you provide more details about the ${claimData.claim_type === 'Accident' ? 'accident circumstances' : 'medical condition'}?
2. Do you have all the required medical reports and bills?
3. Have you informed your insurance company about this claim yet?

Please answer these questions one by one, and I'll guide you through the process.`;

            addMessage('assistant', welcomeMessage);
            enableChatInput();
        }

        function showLoading() {
            document.getElementById('assessmentForm').style.display = 'none';
            document.getElementById('loadingScreen').style.display = 'block';
            updatePhaseIndicator(2, 'ü§ñ AI Analysis Phase', 'Intelligent analysis in progress...');
        }

        function hideLoading() {
            document.getElementById('loadingScreen').style.display = 'none';
        }

        function showConversationalInterface() {
            hideLoading();
            document.getElementById('conversationalInterface').style.display = 'block';
            
            // Show session and plan info
            showSessionInfo();
            showPlanInfo();
        }

        function showSessionInfo() {
            const sessionStatus = document.getElementById('sessionStatus');
            const sessionStatusText = document.getElementById('sessionStatusText');
            sessionStatusText.textContent = 'Active - Enhanced AI Analysis';
            sessionStatus.style.display = 'block';
        }

        function showPlanInfo() {
            const planInfo = document.getElementById('planInfo');
            const activePlanText = document.getElementById('activePlanText');
            activePlanText.textContent = `${claimData.company_name} - ${claimData.plan_name} (${claimData.sum_insured})`;
            planInfo.style.display = 'block';
        }

        function updatePhaseIndicator(phase, title, description) {
            currentPhase = phase;
            document.getElementById('phaseTitle').textContent = title;
            document.getElementById('phaseDescription').textContent = description;
        }

        function enableChatInput() {
            document.getElementById('chatInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('chatInput').focus();
        }

        function onChatInputKeypress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message) return;
            
            // Add user message
            addMessage('user', message);
            chatInput.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Send to AI
                const response = await fetch('/api/chat/message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        message: message,
                        claimData: claimData,
                        planData: planData
                    })
                });

                hideTypingIndicator();

                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.message) {
                        addMessage('assistant', result.message);
                    }
                    
                    if (result.suggestions) {
                        showSuggestions(result.suggestions);
                    }
                    
                    if (result.completed) {
                        showCompletionActions();
                    }
                } else {
                    throw new Error('Failed to get AI response');
                }
                
            } catch (error) {
                console.error('Chat error:', error);
                hideTypingIndicator();
                addMessage('assistant', 'I apologize, but I encountered an error. Please try rephrasing your message or contact support if the issue persists.');
            }
        }

        function addMessage(sender, content) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = formatMessage(content);
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = new Date().toLocaleTimeString();
            
            messageDiv.appendChild(contentDiv);
            messageDiv.appendChild(timeDiv);
            messagesContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Store in conversation history
            conversationHistory.push({ sender, content, timestamp: new Date() });
        }

        function formatMessage(content) {
            // Basic formatting for the message content
            return content
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function showSuggestions(suggestions) {
            const suggestionsContainer = document.getElementById('suggestionsContainer');
            suggestionsContainer.innerHTML = '';
            
            suggestions.forEach(suggestion => {
                const btn = document.createElement('button');
                btn.className = 'suggestion-btn';
                btn.textContent = suggestion;
                btn.onclick = () => {
                    document.getElementById('chatInput').value = suggestion;
                    sendMessage();
                };
                suggestionsContainer.appendChild(btn);
            });
        }

        function showCompletionActions() {
            document.getElementById('downloadBtn').style.display = 'inline-flex';
            document.getElementById('continueBtn').style.display = 'inline-flex';
            addMessage('assistant', 'üéâ **Analysis Complete!** Your claim assessment is ready. You can download the analysis report or continue to the filing process.');
        }

        function resetAssessment() {
            if (confirm('Are you sure you want to start over? This will clear all your progress.')) {
                location.reload();
            }
        }

        function downloadAnalysis() {
            const analysisData = {
                sessionId: sessionId,
                claimData: claimData,
                planData: planData,
                conversationHistory: conversationHistory,
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(analysisData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `claim-analysis-${sessionId}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function continueToFiling() {
            // Navigate to filing interface or next step
            window.location.href = '/filing?sessionId=' + sessionId;
        }

        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
